(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const r of t)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(t){const r={};return t.integrity&&(r.integrity=t.integrity),t.referrerPolicy&&(r.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?r.credentials="include":t.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(t){if(t.ep)return;t.ep=!0;const r=o(t);fetch(t.href,r)}})();function l(e){return document.querySelector(e)}async function b(){return new Promise(e=>{chrome.tabs.query({active:!0,currentWindow:!0},n=>e(n[0]))})}async function y(){const{buckets:e={}}=await chrome.storage.local.get("buckets");return e}function w(e){const[n,o,a]=e.split("|");return{origin:n,tabId:Number(o),startedAtMs:Number(a)}}function x(e){try{return new Date(e).toLocaleTimeString()}catch{return e}}function v(e){const n=["timestamp","url","reason","evidence","suggestedFix","status"],o=t=>'"'+String(t??"").replace(/"/g,'""')+'"',a=e.map(t=>[t.ts,t.url,t.reason,t.evidence,t.suggestedFix,t.status].map(o).join(","));return[n.join(","),...a].join(`
`)}async function m(e,n){const o=new Blob([n],{type:"text/plain"}),a=URL.createObjectURL(o);try{await chrome.downloads.download({url:a,filename:e,saveAs:!1})}finally{setTimeout(()=>URL.revokeObjectURL(a),5e3)}}function p(e){const n=l("#records-tbody");n.innerHTML="";for(const o of e){const a=document.createElement("tr");a.innerHTML=`
      <td class="p-2 align-top whitespace-nowrap">${x(o.ts)}</td>
      <td class="p-2 align-top break-all max-w-[180px]">${o.url}</td>
      <td class="p-2 align-top"><span class="px-1 py-0.5 rounded text-white ${o.status==="blocked"?"bg-red-600":"bg-gray-500"}">${o.reason}</span><div class="text-[10px] text-gray-600 mt-1">${o.evidence||""}</div></td>
      <td class="p-2 align-top break-all max-w-[160px]"><button class="copy-fix px-1 py-0.5 bg-gray-200 rounded" data-fix="${(o.suggestedFix||"").replace(/\"/g,"&quot;")}">Copy</button> <div class="text-[10px] text-gray-600 mt-1">${o.suggestedFix||""}</div></td>
      <td class="p-2 align-top"><button class="ignore-domain text-xs text-blue-700 underline" data-url="${o.url}">Ignore domain</button></td>
    `,n.appendChild(a)}}async function h(){const e=await b(),n=new URL(e.url).origin,o=await y(),t=Object.entries(o).map(([s,i])=>({key:s,meta:w(s),value:i})).filter(s=>s.meta.tabId===e.id&&s.meta.origin===n).sort((s,i)=>i.meta.startedAtMs-s.meta.startedAtMs)[0],r=t?.value?.records||[];l("#session-meta").textContent=t?`Origin: ${n} • Started: ${new Date(t.value.startedAt).toLocaleString()} • Records: ${r.length}`:"No records for this page yet.";let c=r.slice().reverse();p(c),l("#filter-input").addEventListener("input",s=>{const i=s.target.value.toLowerCase();c=r.filter(d=>d.url.toLowerCase().includes(i)||(d.reason||"").toLowerCase().includes(i)),p(c)}),l("#btn-export-json").addEventListener("click",async()=>{const s=JSON.stringify({origin:n,tabId:e.id,exportedAt:new Date().toISOString(),records:r},null,2);await m(`js-block-inspector-${Date.now()}.json`,s)}),l("#btn-export-csv").addEventListener("click",async()=>{const s=v(r);await m(`js-block-inspector-${Date.now()}.csv`,s)}),document.body.addEventListener("click",async s=>{const i=s.target;if(i.matches(".copy-fix")){const d=i.getAttribute("data-fix")||"";await navigator.clipboard.writeText(d),i.textContent="Copied",setTimeout(()=>i.textContent="Copy",1e3)}else if(i.matches(".ignore-domain")){const d=i.getAttribute("data-url"),g=new URL(d).hostname;await new Promise(u=>chrome.runtime.sendMessage({type:"set-ignore-domain",domain:g},()=>u()));const f=r.filter(u=>!new URL(u.url).hostname.endsWith(g));p(f)}})}h().catch(e=>{console.error("Popup init failed",e)});
