const d=new Map,l=new Map,p=new Map,f=new Map,I=new Map;let u=[];const S=["doubleclick","/ads/","googletagmanager","gtm.js","analytics.js","ga.js","adservice","taboola","outbrain","pixel","track","beacon"];function C(e){try{const t=new URL(e);return`${t.protocol}//${t.hostname}${t.port?":"+t.port:""}`}catch{return}}function g(){return new Date().toISOString()}async function q(){const{buckets:e={},ignoreDomains:t=[]}=await chrome.storage.local.get(["buckets","ignoreDomains"]);Object.entries(e).forEach(([r,o])=>{l.set(r,o)}),u=t}async function w(e){const{buckets:t={}}=await chrome.storage.local.get("buckets");t[e]=l.get(e),await chrome.storage.local.set({buckets:t})}function E(e,t){const r=C(t);if(!r)return;const o=d.get(e);if(o&&o.origin===r&&l.has(o.bucketKey))return o.bucketKey;const n=`${r}|${e}|${Date.now()}`,c={startedAt:g(),origin:r,tabId:e,records:[]};return l.set(n,c),d.set(e,{origin:r,bucketKey:n}),w(n).catch(()=>{}),n}function x(e){const t={};if(e.responseHeaders)for(const r of e.responseHeaders)r.name&&(t[r.name.toLowerCase()]=Array.isArray(r.value)?r.value.join(","):r.value||"");return t}function D(e){try{return new URL(e).protocol==="http:"}catch{return!1}}function M(e){try{return new URL(e).hostname}catch{return""}}function v(e){const t=e.toLowerCase();return S.some(r=>t.includes(r))}function h(e){try{const t=new URL(e),r=t.pathname.toLowerCase();if(r.endsWith(".js")||r.includes(".js?")||r.includes("/js/"))return!0;const o=t.search.toLowerCase();return!!(o.includes("format=js")||o.includes("type=js")||o.includes("mime=application/javascript"))}catch{return!1}}function j(e){if(!e)return!1;const t=e.toLowerCase().split(";")[0].trim();return t==="application/javascript"||t==="text/javascript"||t==="application/x-javascript"||t==="text/ecmascript"||t==="application/ecmascript"}function k(e,t){switch(e){case"CSP":return"Update script-src in Content-Security-Policy to include the script's origin or use a nonce/hash.";case"Mixed Content":return"Load the script over HTTPS or proxy it through a secure endpoint.";case"Ad/Tracker Blocker":return"Rename the resource path or host, or serve from a neutral CDN path.";case"DevTools Block":return'In DevTools, uncheck "Block request URL" for this resource or clear the Blocked URLs list.';case"Network Error":return"Verify DNS/hosting/CDN availability and correct URL; check status codes and timeouts.";case"Cross-Origin/MIME":return"Serve with a JavaScript MIME type and avoid nosniff, or correct CORS/mime configuration.";default:return"Inspect DevTools console/network logs for specifics; adjust CSP, URL, or hosting as needed."}}async function m(e,t){const r=d.get(e);if(!r)return;const o=l.get(r.bucketKey);o&&(o.records.push(t),await w(r.bucketKey))}function L(e){const t=M(e);return u.some(r=>r&&t.endsWith(r))}chrome.runtime.onInstalled.addListener(()=>{q().catch(()=>{})});chrome.webNavigation.onCommitted.addListener(e=>{if(e.frameId!==0)return;const{tabId:t,url:r}=e;C(r)&&(E(t,r),I.set(t,{csp:void 0,reportTo:void 0}))});chrome.webRequest.onBeforeRequest.addListener(e=>{e.tabId===-1||L(e.url)||!(e.type==="script"||h(e.url))||p.set(e.requestId,{url:e.url,tabId:e.tabId,startedAt:g()})},{urls:["<all_urls>"]},["blocking"]);chrome.webRequest.onHeadersReceived.addListener(e=>{const t=x(e);if(e.type==="main_frame"){const r=t["content-security-policy"],o=t["report-to"];e.tabId>=0&&I.set(e.tabId,{csp:r,reportTo:o});return}if(e.type==="script"){const r=f.get(e.requestId)||{};r.headers=t,f.set(e.requestId,r)}},{urls:["<all_urls>"]},["responseHeaders","extraHeaders"]);chrome.webRequest.onCompleted.addListener(async e=>{const t=p.get(e.requestId);if(!(e.type==="script"||t&&h(t.url)||h(e.url)))return;const o=t?.tabId??e.tabId;if(typeof o!="number"||o<0)return;const n=t?.url??e.url,a=(f.get(e.requestId)||{headers:{}}).headers||{};e.statusCode;let s,i="";const T=(a["x-content-type-options"]||"").toLowerCase()==="nosniff",b=a["content-type"]||"";if(T&&!j(b)&&(s="Cross-Origin/MIME",i=`X-Content-Type-Options: nosniff; Content-Type: ${b||"missing"}`),!s&&(e.statusCode>=400||e.statusCode===0)&&(s="Network Error",i=`HTTP ${e.statusCode}`),!s&&v(n)&&(s="Ad/Tracker Blocker",i="Matched ad/tracker pattern"),!s){const y=d.get(o);y&&y.origin&&y.origin.startsWith("https:")&&D(n)&&(s="Mixed Content",i="HTTPS page attempted to load HTTP script")}const R=s?"blocked":"executed",B={url:n,reason:s||"Executed",evidence:i,suggestedFix:s?k(s):"",status:R,ts:g()};await m(o,B),p.delete(e.requestId),f.delete(e.requestId)},{urls:["<all_urls>"]});chrome.webRequest.onErrorOccurred.addListener(async e=>{const t=p.get(e.requestId);if(!(e.type==="script"||t&&h(t.url)||h(e.url)))return;const o=t?.tabId??e.tabId;if(typeof o!="number"||o<0)return;const n=t?.url??e.url;if(L(n))return;let c="Network Error",a=e.error;String(e.error||"").includes("ERR_BLOCKED_BY_CLIENT")&&(v(n)?(c="Ad/Tracker Blocker",a=e.error||"Matched ad/tracker pattern"):(c="DevTools Block",a="ERR_BLOCKED_BY_CLIENT (likely DevTools Blocked URLs)"));const i={url:n,reason:c,evidence:a,suggestedFix:k(c),status:"blocked",ts:g()};await m(o,i),p.delete(e.requestId),f.delete(e.requestId)},{urls:["<all_urls>"]});chrome.runtime.onMessage.addListener((e,t,r)=>{if(e&&e.type==="csp-violation"){const{blockedURI:o,effectiveDirective:n,originalPolicy:c,violatedDirective:a}=e.payload||{},s=t?.tab?.id;if(typeof s=="number"&&s>=0){const i={url:o||"(inline/eval)",reason:"CSP",evidence:`Violated: ${a||n}; Policy: ${c?.slice(0,300)||""}`,suggestedFix:k("CSP"),status:"blocked",ts:g()};m(s,i)}}else if(e&&e.type==="get-state"){const o=e.tabId,n={ok:!0};try{n.currentSession=d.get(o)||null}catch{}return r(n),!0}else if(e&&e.type==="set-ignore-domain"){const o=e.domain;return o&&!u.includes(o)&&(u.push(o),chrome.storage.local.set({ignoreDomains:u}).catch(()=>{})),r({ok:!0}),!0}});
